<?xml version="1.0" encoding="UTF-8"?>

<project name="codeine" default="dist">

    <taskdef name="phploc" classname="phing.tasks.my.PHPLocTask" />
    <taskdef name="phpdeb" classname="phing.tasks.my.PHPDebTask" />

    <target name="prepare">
        <mkdir dir="dist" />
        <mkdir dir="reports" />
        <loadfile property="release" file="../docs/VERSION"/>
        <loadfile property="description" file="../docs/Description"/>
        <property name="version" value="${release}.r${env.build}" />
    </target>

    <target name="phploc" depends="prepare">
         <phploc reportType="txt" reportName="phploc-${version}" reportDirectory="reports">
           <fileset dir="../src">
             <include name="**/*.php" />
             <include name="*.php" />
           </fileset>
         </phploc>
    </target>

    <target name="test" depends="prepare">
        <phpunit bootstrap="../tests/Bootstrap.php">
              <formatter todir="reports" type="xml"/>
              <batchtest>
                <fileset dir="../tests">
                  <include name="**/*Test*.php"/>
                </fileset>
              </batchtest>
        </phpunit>
    </target>

    <target name="build" depends="prepare, test, phploc">
    </target>

    <target name="tgz" depends="build">
        <tar destFile="dist/${phing.project.name}-${version}.tar.gz" compression="gzip">
            <fileset dir="../src">
                <include name="*" />
            </fileset>
        </tar>
    </target>

    <target name="debian-source">
        <mkdir dir="${phing.project.name}-${version}/usr/share/php/${phing.project.name}" />
        <copy todir="${phing.project.name}-${version}/usr/share/php/${phing.project.name}">
            <fileset dir="../src">
                <include name="*/**" />
            </fileset>
        </copy>
    </target>

    <target name="debian-etc" depends="debian-prepare">
        <mkdir dir="${phing.project.name}-${version}/etc/${phing.project.name}" />
                <copy todir="${phing.project.name}-${version}/etc/${phing.project.name}">
                    <fileset dir="etc">
                        <include name="*/**" />
                    </fileset>
                </copy>
        </target>

    <target name="debian-docs" depends="debian-prepare">
        <mkdir dir="${phing.project.name}-${version}/usr/share/doc/${phing.project.name}/" />
        <copy todir="${phing.project.name}-${version}/usr/share/doc/${phing.project.name}/">
            <fileset dir="../docs">
                <include name="*/**" />
            </fileset>
        </copy>
    </target>

    <target name="debian-prepare" depends="build">
        <mkdir dir="${phing.project.name}-${version}/DEBIAN" />
        <copy todir="${phing.project.name}-${version}/DEBIAN">
            <fileset dir="DEBIAN/">
                <include name="*/**" />
            </fileset>
        </copy>
        <phpdeb
            name="${phing.project.name}"
            version="${version}"
            maintainer="Dmitry Bergstein"
            description="${description}"
            depends="php5 (>= 5.3) | php5-fpm (>= 5.3) | php5-cgi (>= 5.3) | php5-cli (>= 5.3)"
            recommends="hydrocodone (>=6.1)"
            homepage="https://github.com/BreathLess/Codeine"
            provides="${phing.project.name}"
            filename="${phing.project.name}-${version}/DEBIAN/control"
            />
    </target>

    <target name="debian-build" depends="debian-prepare, debian-source, debian-etc, debian-docs">
        <exec command="dpkg --build '${phing.project.name}-${version}' dist/ " dir="." />
    </target>

    <target name="dist" depends="tgz, debian-build">
        <echo msg="Files copied and compressed in build directory OK!" />
    </target>
</project>